# jOOQ Integration

jOOQ is the library used to integrate with PostgreSQL at Bitso. Code generation ensures type safety in queries.

## Contents

- [Generated Code Usage](#generated-code-usage)
- [Version Compatibility](#version-compatibility)
- [Fixing jOOQ Version Conflicts](#fixing-jooq-version-conflicts)
- [jOOQ Configuration (gradle/jooq-config.gradle)](#jooq-configuration-gradlejooq-configgradle)
- [Spring Context Configuration](#spring-context-configuration)
- [Application Configuration](#application-configuration)

---
## Generated Code Usage

Records generated by jOOQ code generation must only be used in the persistence layer. The persistence layer will receive and return models defined in the API of the subdomain.

## Version Compatibility

### Java 21 (Gradle 8.x)

```toml
[versions]
postgresql = "42.7.8"
testcontainers = "1.21.4"
jooq = "3.19.28"  # Spring Boot 3.5.x BOM version
flyway = "11.7.2"

[plugins]
flyway = { id = "org.flywaydb.flyway", version.ref = "flyway" }
jooq = { id = "nu.studer.jooq", version = "9.0" }
```

### Java 25 (Gradle 9.x)

```toml
[versions]
postgresql = "42.7.8"
testcontainers = "1.21.4"
jooq = "3.20.10"
flyway = "11.19.0"

[plugins]
flyway = { id = "org.flywaydb.flyway", version.ref = "flyway" }
jooq = { id = "nu.studer.jooq", version = "10.1.1" }
```

## Fixing jOOQ Version Conflicts

The `bitso.java.module` plugin can force jOOQ to older versions. Use `dependencySubstitution`:

```groovy
// In jooq-config.gradle
configurations.named('jooqGenerator').configure {
    resolutionStrategy {
        dependencySubstitution {
            substitute module('org.jooq:jooq') using module("org.jooq:jooq:${libs.versions.jooq.get()}")
            substitute module('org.jooq:jooq-meta') using module("org.jooq:jooq-meta:${libs.versions.jooq.get()}")
            substitute module('org.jooq:jooq-codegen') using module("org.jooq:jooq-codegen:${libs.versions.jooq.get()}")
        }
    }
}
```

## jOOQ Configuration (gradle/jooq-config.gradle)

```groovy
buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath "org.testcontainers:postgresql:${libs.versions.testcontainers.get()}"
    }
}

jooq {
    version = "${libs.versions.jooq.get()}"
    configurations {
        main {
            generateSchemaSourceOnCompilation = false
            generationTool {
                logging = 'WARN'
                jdbc {
                    driver = 'org.postgresql.Driver'
                }
                generator {
                    name = 'org.jooq.codegen.DefaultGenerator'
                    database {
                        name = 'org.jooq.meta.postgres.PostgresDatabase'
                        inputSchema = 'public'
                    }
                    generate {
                        indexes = false
                    }
                    target {
                        directory = 'src/generated/jooq/main'
                    }
                    strategy.name = 'org.jooq.codegen.DefaultGeneratorStrategy'
                }
            }
        }
    }
}

task postgresContainer {
    doFirst {
        def dbTestContainer = new org.testcontainers.containers.PostgreSQLContainer('postgres:14')
                .withDatabaseName('mydb')
                .withUsername('myuser')
                .withPassword('mypass')
        dbTestContainer.start()
        ext.instance = dbTestContainer
        
        jooq {
            configurations {
                main {
                    generationTool {
                        jdbc {
                            username = dbTestContainer.username
                            password = dbTestContainer.password
                            url = dbTestContainer.jdbcUrl
                        }
                    }
                }
            }
        }
        
        flyway {
            url = dbTestContainer.jdbcUrl
        }
    }
    finalizedBy flywayMigrate
}

tasks.named('generateJooq').configure {
    doFirst {
        delete "${project.projectDir}/src/generated/jooq/main"
    }
    dependsOn postgresContainer
    doLast {
        postgresContainer.ext.properties.instance?.stop()
    }
    allInputsDeclared = true
    outputs.cacheIf { false }
}
```

## Spring Context Configuration

For read/write splitting:

```java
@Configuration
@EnableTransactionManagement
public class JooqConfiguration {

    @Bean(name = "readHikariConfig")
    @ConfigurationProperties(prefix = "spring.datasource.read")
    public HikariConfig readHikariConfig() {
        return new HikariConfig();
    }

    @Bean(name = "writeHikariConfig")
    @ConfigurationProperties(prefix = "spring.datasource.write")
    public HikariConfig writeHikariConfig() {
        return new HikariConfig();
    }

    @Bean(name = "readDataSource")
    public DataSource readDataSource(@Qualifier("readHikariConfig") HikariConfig config) {
        return new RdsIamDataSource(config);
    }

    @Primary
    @Bean(name = "writeDataSource")
    public DataSource writeDataSource(@Qualifier("writeHikariConfig") HikariConfig config) {
        return new RdsIamDataSource(config);
    }

    @Bean(name = "transactionManager")
    public DataSourceTransactionManager transactionManager(@Qualifier("writeDataSource") DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }

    @Bean(name = "readDslContext")
    public DSLContext readDslContext(@Qualifier("readDataSource") DataSource dataSource) {
        DefaultConfiguration jooqConfig = new DefaultConfiguration();
        jooqConfig.setSQLDialect(SQLDialect.POSTGRES);
        jooqConfig.set(new DataSourceConnectionProvider(new TransactionAwareDataSourceProxy(dataSource)));
        return new DefaultDSLContext(jooqConfig);
    }

    @Primary
    @Bean(name = "writeDslContext")
    public DSLContext writeDslContext(@Qualifier("writeDataSource") DataSource dataSource) {
        DefaultConfiguration jooqConfig = new DefaultConfiguration();
        jooqConfig.setSQLDialect(SQLDialect.POSTGRES);
        jooqConfig.set(new DataSourceConnectionProvider(new TransactionAwareDataSourceProxy(dataSource)));
        return new DefaultDSLContext(jooqConfig);
    }
}
```

## Application Configuration

```yaml
spring:
  datasource:
    read:
      jdbcUrl: jdbc:postgresql://${DB_RO_HOST:localhost}:${DB_PORT:5432}/mydb
      type: com.bitso.rds.iam.auth.RdsIamDataSource
      username: myuser
      maximumPoolSize: 20
      readOnly: true
    write:
      jdbcUrl: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/mydb
      type: com.bitso.rds.iam.auth.RdsIamDataSource
      username: myuser
      maximumPoolSize: 20
```
<!-- AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY -->
<!-- Source: bitsoex/ai-code-instructions â†’ java/skills/database-integration/references/jooq.md -->
<!-- To modify, edit the source file and run the distribution workflow -->

