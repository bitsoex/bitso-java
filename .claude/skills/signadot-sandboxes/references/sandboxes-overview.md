# Sandboxes Overview

> Source: [Bitso Confluence - Sandboxes](https://bitsomx.atlassian.net/wiki/spaces/BAB/pages/5089263857/Sandboxes)

## Contents

- [What is a Sandbox](#what-is-a-sandbox)
- [How Sandboxes are Created](#how-sandboxes-are-created)
- [Naming Convention](#naming-convention)
- [Routing Keys](#routing-keys)
- [How to Use a Sandbox](#how-to-use-a-sandbox)
- [Sandbox Deletion and TTL](#sandbox-deletion-and-ttl)
- [Enabling Sandboxes in Estate Catalogue](#enabling-sandboxes-in-estate-catalogue)
- [Available Features](#available-features)

---
## What is a Sandbox

A Signadot Sandbox is an isolated, logical environment within the stage Kubernetes cluster that incorporates the changes from a pull request. Workloads running in the sandbox can interact with all existing cluster resources, just as they would in the main environment.

Each sandbox contains only the changes introduced by the specific PR it is associated with. This granularity ensures tests are focused solely on the PR's modifications, preventing interference from other development branches.

## How Sandboxes are Created

When a PR is opened in a repository where Signadot is enabled, a new job is automatically added to the CI workflow after the build process. If the build completes successfully and new Docker images are generated, the Signadot job automatically provisions a new sandbox.

The sandbox creation process:

1. Deploys forked versions of affected services on the stage cluster
2. Creates new ConfigMaps for the affected services and CronJobs
3. Generates a unique routing key for traffic isolation
4. Posts the routing key as a PR comment

## Naming Convention

Sandboxes follow the pattern: `<repository-name>-<pr-number>`

Examples:
- `stocks-416`
- `bff-services-605`
- `bitso-transfer-53`

Resource blocks within sandboxes use initials and a 4-character SHA (max 20 chars):
- `entity-health-logs-processor` becomes `ehlp760a`
- `service-health-metrics-processor` becomes `shmpf152`

## Routing Keys

The routing key is a unique 13-character alphanumeric string (e.g., `zx4ygbjd5k4s4`) generated by Signadot when the sandbox is created.

Find the routing key:

1. **PR comments**: The `signadot bot` posts it automatically
2. **Signadot dashboard**: [app.signadot.com/sandboxes](https://app.signadot.com/sandboxes)
3. **CLI**: `signadot sandbox get <sandbox-id>`

## How to Use a Sandbox

### Browser testing

- **Signadot browser extension**: Auto-discovers active sandboxes and injects the routing key. Install from [Chrome Web Store](https://chromewebstore.google.com/detail/signadot/aigejiccjejdeiikegdjlofgcjhhnkim).
- **ModHeader extension**: Manually add header `ot-baggage-bitso: <routing-key>`.

### Command-line testing

```bash
curl -H 'ot-baggage-bitso: <routing-key>' https://stage.example.com/api/endpoint
```

### Context propagation

The routing key is propagated through all downstream service calls automatically via Datadog libraries. See [context propagation](context-propagation.md) for details.

## Sandbox Deletion and TTL

Sandboxes are automatically cleaned up:

- **PR closed/merged**: Signadot detects the change and deletes the sandbox
- **48-hour TTL**: Sandboxes expire automatically if the PR remains open beyond 48 hours

If a resource block is in a failed status, the sandbox can only be deleted by force (tick the "force delete" option in the Signadot dashboard).

## Enabling Sandboxes in Estate Catalogue

Add the `sandbox: true` flag to the repository's `.cue` file in the Estate Catalogue:

```cue
ci: {
    sandbox: true
}
```

Location: `catalog/repos/<repository-name>.cue`

Submit a PR to the Estate Catalogue. After merge, any new PRs in the repository that include Docker image changes will trigger automatic sandbox creation.

## Available Features

**Working:**

- Docker image deployment
- ConfigMap deployment
- CronJob deployment
- Message isolation on shared topics (Kafka, SQS)

**Under investigation:**

- Virtual Services
- Message isolation on shared topics (Redis Streams, SNS)
<!-- AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY -->
<!-- Source: bitsoex/ai-code-instructions â†’ global/skills/signadot-sandboxes/references/sandboxes-overview.md -->
<!-- To modify, edit the source file and run the distribution workflow -->

